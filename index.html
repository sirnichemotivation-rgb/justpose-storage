<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JUSTPOSE GALLERY</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 10px; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .img-card { background: #111; border-radius: 12px; overflow: hidden; height: 200px; border: 1px solid #333; cursor: pointer; }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }
        #photoModal { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; flex-direction: column; }
        #modalContent { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100vw; height: 100vh; }
        .folder-item { min-width: 100vw; height: 100vh; scroll-snap-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .folder-item img, .folder-item video { max-width: 95%; max-height: 80%; border-radius: 8px; }
        .close-x { position: absolute; top: 20px; left: 20px; font-size: 35px; color: #fff; z-index: 2001; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 45px; height: 45px; text-align: center; }
        .dl-btn { margin-top: 15px; background: #fff; color: #000; padding: 10px 25px; border-radius: 20px; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <header style="text-align:center; padding: 20px;"><h2>JUSTPOSE LIVE GALLERY</h2></header>
    <div id="gallery"></div>

    <div id="photoModal">
        <span class="close-x" onclick="closeModal()">âœ•</span>
        <div id="modalContent"></div>
    </div>

    <script>
        const GH_USER = "sirnichemotivation-rgb";
        const GH_REPO = "justpose-storage";
        const eventId = new URLSearchParams(window.location.search).get('event');

        async function loadGallery() {
            if (!eventId) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}?t=${Date.now()}`);
                const sessions = await res.json();
                const gal = document.getElementById('gallery');
                
                sessions.sort((a, b) => b.name.localeCompare(a.name, undefined, {numeric: true}));
                gal.innerHTML = "";

                for (let s of sessions) {
                    if (s.type === 'dir') {
                        let card = document.createElement('div');
                        card.className = "img-card";
                        card.onclick = () => openSession(s.name);
                        
                        // Kunin ang Print Thumbnail mula sa 'Thumb' folder
                        const tRes = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}/${s.name}/Thumb`);
                        const thumb = await tRes.json();
                        if (thumb[0]) card.innerHTML = `<img src="${thumb[0].download_url}">`;
                        gal.appendChild(card);
                    }
                }
            } catch (e) {}
        }

        async function openSession(sid) {
            const modal = document.getElementById('photoModal');
            const cont = document.getElementById('modalContent');
            modal.style.display = "flex";
            cont.innerHTML = "<div style='color:white; padding:50px;'>Loading Gallery...</div>";

            try {
                // Kunin lahat mula sa Thumb at Media folders
                let allMedia = [];
                const paths = ['Thumb', 'Media'];
                for (let p of paths) {
                    const r = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}/${sid}/${p}`);
                    const files = await r.json();
                    if (Array.isArray(files)) allMedia = allMedia.concat(files);
                }

                cont.innerHTML = "";
                allMedia.forEach(m => {
                    let div = document.createElement('div');
                    div.className = "folder-item";
                    let isVid = m.name.toLowerCase().endsWith('.mp4');
                    div.innerHTML = `
                        ${isVid ? `<video src="${m.download_url}" controls autoplay loop></video>` : `<img src="${m.download_url}">`}
                        <a href="${m.download_url}" download class="dl-btn">SAVE TO PHONE</a>
                    `;
                    cont.appendChild(div);
                });
            } catch(e) { cont.innerHTML = "Error loading files."; }
        }

        function closeModal() { document.getElementById('photoModal').style.display = "none"; }
        loadGallery();
        setInterval(loadGallery, 15000); // Auto-refresh every 15s
    </script>
</body>
</html>
