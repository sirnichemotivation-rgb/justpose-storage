<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JUSTPOSE GALLERY</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 10px; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .img-card { background: #111; border-radius: 8px; overflow: hidden; height: 180px; border: 1px solid #222; }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }
        #photoModal { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; flex-direction: column; }
        #modalContent { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100vw; height: 100vh; }
        .folder-item { min-width: 100vw; height: 100vh; scroll-snap-align: center; display: flex; justify-content: center; align-items: center; position: relative; }
        .folder-item img, .folder-item video { max-width: 90%; max-height: 80%; }
        .close-x { position: absolute; top: 20px; left: 20px; font-size: 30px; color: #fff; z-index: 2001; }
    </style>
</head>
<body>
    <header style="text-align:center; padding: 20px;"><h1>JUSTPOSE GALLERY</h1></header>
    <div id="gallery"></div>

    <div id="photoModal">
        <span class="close-x" onclick="closeModal()">âœ•</span>
        <div id="modalContent"></div>
    </div>

    <script>
        const GH_USER = "sirnichemotivation-rgb";
        const GH_REPO = "justpose-storage";
        const eventId = new URLSearchParams(window.location.search).get('event');

        async function loadGallery() {
            if (!eventId) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}`);
                const folders = await res.json();
                const gal = document.getElementById('gallery');
                
                folders.sort((a, b) => b.name.localeCompare(a.name, undefined, {numeric: true}));
                gal.innerHTML = "";

                for (let f of folders) {
                    if (f.type === 'dir') {
                        let card = document.createElement('div');
                        card.className = "img-card";
                        card.onclick = () => openSession(f.name);
                        
                        // Kumuha ng thumbnail mula sa Media folder
                        const mRes = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}/${f.name}/Media`);
                        const media = await mRes.json();
                        if (media[0]) card.innerHTML = `<img src="${media[0].download_url}">`;
                        gal.appendChild(card);
                    }
                }
            } catch (e) {}
        }

        async function openSession(sid) {
            const modal = document.getElementById('photoModal');
            const cont = document.getElementById('modalContent');
            modal.style.display = "flex";
            cont.innerHTML = "<div style='color:white; padding:20px;'>Loading Media...</div>";

            try {
                // UPDATE: Binabasa ang Media folder structure
                const r = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/Events/${eventId}/${sid}/Media`);
                const media = await r.json();
                
                cont.innerHTML = "";
                media.forEach(m => {
                    let div = document.createElement('div');
                    div.className = "folder-item";
                    let isVid = m.name.toLowerCase().endsWith('.mp4');
                    div.innerHTML = isVid ? `<video src="${m.download_url}" controls autoplay loop></video>` : `<img src="${m.download_url}">`;
                    cont.appendChild(div);
                });
            } catch(e) { cont.innerHTML = "Error loading files."; }
        }

        function closeModal() { document.getElementById('photoModal').style.display = "none"; }
        loadGallery();
        setInterval(loadGallery, 15000);
    </script>
</body>
</html>
