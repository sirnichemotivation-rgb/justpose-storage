<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JUSTPOSE GALLERY</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 10px; overflow-x: hidden; }
        header h1 { text-align: center; font-size: 22px; letter-spacing: 2px; margin: 20px 0; }

        /* GRID VIEW */
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .img-card { background: #111; border-radius: 12px; overflow: hidden; height: 200px; cursor: pointer; border: 1px solid #222; }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }

        /* FULLSCREEN MODAL & HORIZONTAL SWIPE */
        #photoModal { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; flex-direction: column; }
        #modalContent {
            display: flex !important;
            flex-direction: row !important; /* Force Left-to-Right */
            overflow-x: auto !important;
            scroll-snap-type: x mandatory;
            width: 100vw; height: 100vh;
        }
        #modalContent::-webkit-scrollbar { display: none; }

        .folder-item {
            min-width: 100vw; height: 100vh;
            scroll-snap-align: center;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        .folder-item img, .folder-item video { max-width: 95%; max-height: 80%; border-radius: 8px; }

        /* UI BUTTONS */
        .dl-btn {
            position: absolute; top: 30px; right: 20px; background: #fff; color: #000;
            padding: 10px 20px; border-radius: 30px; font-weight: bold; text-decoration: none; z-index: 2000;
        }
        .close-x { position: absolute; top: 25px; left: 20px; font-size: 35px; color: #fff; cursor: pointer; z-index: 2000; }
    </style>
</head>
<body>
    <header><h1>JUSTPOSE GALLERY</h1></header>
    <div id="gallery"></div>

    <div id="photoModal">
        <span class="close-x" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
    </div>

    <script>
        const GH_USER = "sirnichemotivation-rgb";
        const GH_REPO = "justpose-storage";
        const eventId = new URLSearchParams(window.location.search).get('event');

        async function loadGallery() {
            if (!eventId) {
                document.getElementById('gallery').innerHTML = "<p style='text-align:center;'>Missing Event ID.</p>";
                return;
            }
            try {
                // Fetch directly from root based on your repo structure
                const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}`);
                const folders = await res.json();
                const gal = document.getElementById('gallery');
                gal.innerHTML = "";
                
                // Sort Sessions (Newest First)
                folders.sort((a, b) => b.name.localeCompare(a.name, undefined, {numeric: true}));

                for (let f of folders) {
                    if (f.type === 'dir') {
                        let card = document.createElement('div');
                        card.className = "img-card";
                        card.onclick = () => openSession(f.name);
                        
                        // Use Print as thumbnail
                        try {
                            const pRes = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}/${f.name}/Prints`);
                            const prints = await pRes.json();
                            if (prints[0]) card.innerHTML = `<img src="${prints[0].download_url}">`;
                        } catch(e) { card.innerHTML = `<div style="padding:20px">${f.name}</div>`; }
                        
                        gal.appendChild(card);
                    }
                }
            } catch (e) { document.getElementById('gallery').innerHTML = "Sessions not found yet."; }
        }

        async function openSession(sid) {
            const modal = document.getElementById('photoModal');
            const cont = document.getElementById('modalContent');
            modal.style.display = "flex";
            cont.innerHTML = "<div style='color:white;width:100%;text-align:center;'>Loading session...</div>";

            let media = [];
            const subs = ['Prints', 'Singles', 'Animated']; // Scans all subfolders
            for (let s of subs) {
                try {
                    const r = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}/${sid}/${s}`);
                    const data = await r.json();
                    if (Array.isArray(data)) media = media.concat(data);
                } catch(e) {}
            }

            cont.innerHTML = "";
            media.forEach(m => {
                let div = document.createElement('div');
                div.className = "folder-item";
                let isVid = m.name.toLowerCase().endsWith('.mp4');
                div.innerHTML = `
                    <a href="${m.download_url}" download="${m.name}" class="dl-btn">SAVE</a>
                    ${isVid ? `<video src="${m.download_url}" controls autoplay loop playsinline></video>` : `<img src="${m.download_url}">`}
                `;
                cont.appendChild(div);
            });
        }

        function closeModal() { document.getElementById('photoModal').style.display = "none"; }
        loadGallery();
    </script>
</body>
</html>
