<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JUSTPOSE LIVE GALLERY</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 10px; }
        header { display: flex; justify-content: center; align-items: center; padding: 10px; }
        .live-indicator { color: #0f0; font-size: 10px; font-weight: bold; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .img-card { background: #111; border-radius: 10px; overflow: hidden; height: 180px; position: relative; }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }
        
        /*  */
        #photoModal { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; flex-direction: column; }
        #modalContent {
            display: flex !important;
            flex-direction: row !important;
            overflow-x: auto !important;
            scroll-snap-type: x mandatory;
            width: 100vw; height: 100vh;
        }
        .folder-item { min-width: 100vw; height: 100vh; scroll-snap-align: center; display: flex; justify-content: center; align-items: center; position: relative; }
        .folder-item img, .folder-item video { max-width: 95%; max-height: 85%; object-fit: contain; }
        
        .dl-btn { position: absolute; top: 20px; right: 20px; background: #fff; color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; text-decoration: none; z-index: 2000; }
        .close-x { position: absolute; top: 20px; left: 20px; font-size: 30px; color: #fff; z-index: 2000; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <div class="live-indicator">‚óè LIVE</div>
        <h1 style="font-size: 18px;">JUSTPOSE GALLERY</h1>
    </header>

    <div id="gallery"></div>

    <div id="photoModal">
        <span class="close-x" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
    </div>

    <script>
        const GH_USER = "sirnichemotivation-rgb";
        const GH_REPO = "justpose-storage";
        const eventId = new URLSearchParams(window.location.search).get('event');

        async function loadGallery() {
            if (!eventId) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}?t=${Date.now()}`);
                const folders = await res.json();
                const gal = document.getElementById('gallery');
                
                // Compare count para iwas refresh kung walang bago
                if (gal.childElementCount === folders.filter(f => f.type === 'dir').length) return;

                gal.innerHTML = "";
                folders.sort((a, b) => b.name.localeCompare(a.name, undefined, {numeric: true}));

                for (let f of folders) {
                    if (f.type === 'dir') {
                        let card = document.createElement('div');
                        card.className = "img-card";
                        card.onclick = () => openSession(f.name);
                        
                        const pRes = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}/${f.name}/Prints`);
                        const prints = await pRes.json();
                        if (prints[0]) card.innerHTML = `<img src="${prints[0].download_url}">`;
                        gal.appendChild(card);
                    }
                }
            } catch (e) {}
        }

        async function openSession(sid) {
            const modal = document.getElementById('photoModal');
            const cont = document.getElementById('modalContent');
            modal.style.display = "flex";
            cont.innerHTML = "Loading...";

            let media = [];
            const subs = ['Prints', 'Singles', 'Animated'];
            for (let s of subs) {
                try {
                    const r = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${eventId}/${sid}/${s}`);
                    const data = await r.json();
                    if (Array.isArray(data)) media = media.concat(data);
                } catch(e) {}
            }

            cont.innerHTML = "";
            media.forEach(m => {
                let div = document.createElement('div');
                div.className = "folder-item";
                let isVid = m.name.toLowerCase().endsWith('.mp4');
                div.innerHTML = `
                    <a href="${m.download_url}" download class="dl-btn">SAVE</a>
                    ${isVid ? `<video src="${m.download_url}" controls autoplay loop playsinline></video>` : `<img src="${m.download_url}">`}
                `;
                cont.appendChild(div);
            });
        }

        function closeModal() { document.getElementById('photoModal').style.display = "none"; }
        
        // Auto-refresh every 10 seconds para sa mga bagong upload
        setInterval(loadGallery, 10000);
        loadGallery();
    </script>
</body>
</html>
